{% extends "base.html" %}
{% load static %}
{% block title %}AI Triage · CareLink{% endblock %}
{% block content %}
<div style="background: var(--cl-bg); min-height: calc(100vh - 200px);">
  <!-- Page Header -->
  <header style="background: white; border-bottom: 1px solid var(--cl-border);">
    <div class="container py-3">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <a href="{% url 'home:index' %}" class="btn btn-sm" style="background: transparent; border: none; color: var(--cl-text-muted);">
            <i class="fas fa-arrow-left"></i>
          </a>
          <div>
            <h2 class="mb-0" style="font-size: var(--cl-h3); color: var(--cl-text);">AI Health Triage</h2>
            <p class="mb-0" style="font-size: var(--cl-sm); color: var(--cl-text-muted);">Get instant symptom assessment</p>
          </div>
        </div>
        <a href="{% url 'triage:history' %}" class="btn btn-outline-primary">
          <i class="fas fa-history me-2"></i>History
        </a>
      </div>
    </div>
  </header>

  <div class="container py-4">
    <div class="row g-4">
      <!-- Chat Interface -->
      <div class="col-lg-9">
        <div class="card h-100" style="border: 1px solid var(--cl-border); min-height: 600px; display: flex; flex-direction: column;">
          <!-- Messages Area -->
          <div id="messagesContainer" class="card-body flex-grow-1 overflow-auto p-4" style="max-height: 500px;">
            <!-- Default assistant greeting -->
            <div class="mb-4">
              <div class="d-flex align-items-start gap-3">
                <div class="d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem; border-radius: 50%; background: var(--cl-blue); color: white; flex-shrink: 0;">
                  <i class="fas fa-info-circle fa-sm"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="card p-3" style="background: white; border: 1px solid var(--cl-border); border-radius: var(--cl-radius-lg); max-width: 80%;">
                    <small class="d-block mb-2" style="color: var(--cl-text-muted);">AI Assistant</small>
                    <p class="mb-0" style="font-size: var(--cl-sm); color: var(--cl-text);">
                      Hello! I'm your CareLink AI Health Assistant. I'm here to help assess your symptoms. Please describe what you're experiencing today.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Input Area -->
          <div class="border-top p-3" style="border-color: var(--cl-border);">
            <form id="triageForm" class="d-flex gap-2">
              {% csrf_token %}
              <textarea id="symptoms" name="symptoms" rows="2" class="form-control" placeholder="Describe your symptoms..." style="resize: none; border: 1px solid var(--cl-border);"></textarea>
              <button type="submit" class="btn btn-primary" style="height: fit-content; align-self: flex-end;">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
            <small class="text-muted mt-2 d-block">
              Press Enter to send • Shift + Enter for new line
            </small>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-3">
        <div class="d-flex flex-column gap-3">
          <!-- Context used -->
          {% if patient_ctx %}
          <div class="card" style="border: 1px solid var(--cl-border);">
            <div class="card-header bg-transparent border-bottom">
              <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">Context used</h5>
            </div>
            <div class="card-body">
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
                <div><strong>Age:</strong> {{ patient_ctx.age|default:"Unknown" }}</div>
                <div><strong>Weight:</strong> {{ patient_ctx.weight|default:"Unknown" }}</div>
                <div style="grid-column: 1 / -1;"><strong>Allergies:</strong> {{ patient_ctx.allergies|default:"None reported" }}</div>
                <div style="grid-column: 1 / -1;"><strong>Medical history:</strong> {{ patient_ctx.medical_history|default:"None reported" }}</div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Severity Assessment -->
          <div class="card" style="border: 1px solid var(--cl-border);">
            <div class="card-header bg-transparent border-bottom">
              <h5 class="mb-0 d-flex align-items-center gap-2" style="font-size: var(--cl-h4); color: var(--cl-text);">
                <i class="fas fa-exclamation-triangle" style="color: var(--cl-amber);"></i>
                Severity Assessment
              </h5>
            </div>
            <div id="severityDisplay" class="card-body text-center">
              <i class="fas fa-info-circle fa-3x mb-3" style="color: var(--cl-border);"></i>
              <p class="text-muted mb-0" style="font-size: var(--cl-sm);">Severity will be assessed after you submit</p>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="border: 1px solid var(--cl-border);">
            <div class="card-header bg-transparent border-bottom">
              <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column gap-2">
                <a href="{% url 'doctors:index' %}" class="btn btn-primary w-100 text-start">
                  <i class="fas fa-map-marker-alt me-2"></i>Find Nearby Care
                </a>
                <a href="{% url 'appointments:index' %}" class="btn btn-outline-success w-100 text-start">
                  <i class="fas fa-check-circle me-2"></i>Book Appointment
                </a>
              </div>
            </div>
          </div>

          <!-- Emergency Notice -->
          <div class="card" style="border: 2px solid var(--cl-red); background: #fef2f2;">
            <div class="card-body">
              <div class="d-flex gap-3">
                <i class="fas fa-exclamation-triangle fa-lg" style="color: var(--cl-red); flex-shrink: 0; margin-top: 0.125rem;"></i>
                <div>
                  <h6 class="mb-2" style="color: var(--cl-red); font-weight: var(--cl-font-medium);">Emergency?</h6>
                  <p class="mb-3" style="font-size: var(--cl-xs); color: var(--cl-text-muted);">If you're experiencing a medical emergency, call 911 immediately.</p>
                  <button class="btn btn-danger btn-sm w-100">Call 911</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('symptoms');
  const form = document.getElementById('triageForm');
  const messagesContainer = document.getElementById('messagesContainer');
  const severityDisplay = document.getElementById('severityDisplay');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Track conversation history
  let conversationHistory = [];

  // Function to scroll to bottom of messages
  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Function to add user message
  function addUserMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4';
    messageDiv.innerHTML = `
      <div class="d-flex align-items-start gap-3" style="justify-content: flex-end;">
        <div class="flex-grow-1"></div>
        <div class="card p-3" style="background: var(--cl-muted-bg); border: 1px solid var(--cl-border); border-radius: var(--cl-radius-lg); max-width: 80%;">
          <small class="d-block mb-2" style="color: var(--cl-text-muted); text-align:right;">You</small>
          <p class="mb-0" style="font-size: var(--cl-sm); color: var(--cl-text); text-align:right;">${escapeHtml(text)}</p>
        </div>
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
  }

  // Function to add loading message
  function addLoadingMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4';
    messageDiv.id = 'loadingMessage';
    messageDiv.innerHTML = `
      <div class="d-flex align-items-start gap-3">
        <div class="d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem; border-radius: 50%; background: var(--cl-blue); color: white; flex-shrink: 0;">
          <i class="fas fa-robot fa-sm"></i>
        </div>
        <div class="flex-grow-1">
          <div class="card p-3" style="background: white; border: 1px solid var(--cl-border); border-radius: var(--cl-radius-lg); max-width: 80%;">
            <small class="d-block mb-2" style="color: var(--cl-text-muted);">AI Assistant</small>
            <div class="d-flex gap-2 align-items-center">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span style="font-size: var(--cl-sm); color: var(--cl-text-muted);">Analyzing your symptoms...</span>
            </div>
          </div>
        </div>
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
  }

  // Function to remove loading message
  function removeLoadingMessage() {
    const loadingMsg = document.getElementById('loadingMessage');
    if (loadingMsg) {
      loadingMsg.remove();
    }
  }

  // Function to get severity color
  function getSeverityColor(severity) {
    switch(severity) {
      case 'Critical': return 'var(--cl-red)';
      case 'Severe': return 'var(--cl-amber)';
      case 'Moderate': return 'var(--cl-teal)';
      default: return 'var(--cl-green)';
    }
  }

  // Function to add AI response
  function addAIResponse(result) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4';

    let redFlagsHtml = '';
    if (result.red_flags && result.red_flags.length > 0) {
      redFlagsHtml = `
        <p class="mb-2"><strong>Red flags:</strong></p>
        <ul class="mb-2" style="margin-left: 1rem;">
          ${result.red_flags.map(rf => `<li>${escapeHtml(rf)}</li>`).join('')}
        </ul>
      `;
    }

    let differentialHtml = '';
    if (result.differential && result.differential.length > 0) {
      differentialHtml = `
        <p class="mb-2"><strong>Possible causes (not a diagnosis):</strong></p>
        <ul class="mb-2" style="margin-left: 1rem;">
          ${result.differential.map(d => `<li>${escapeHtml(d)}</li>`).join('')}
        </ul>
      `;
    }

    let adviceHtml = '';
    if (result.advice) {
      adviceHtml = `<div class="alert info mb-0"><strong>Advice:</strong> ${escapeHtml(result.advice)}</div>`;
    }

    messageDiv.innerHTML = `
      <div class="d-flex align-items-start gap-3">
        <div class="d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem; border-radius: 50%; background: var(--cl-blue); color: white; flex-shrink: 0;">
          <i class="fas fa-robot fa-sm"></i>
        </div>
        <div class="flex-grow-1">
          <div class="card p-3" style="background: white; border: 1px solid var(--cl-border); border-radius: var(--cl-radius-lg); max-width: 80%;">
            <div class="d-flex align-items-center gap-2 mb-2">
              <small class="d-block" style="color: var(--cl-text-muted);">AI Assistant</small>
              <span class="badge" style="padding:4px 8px;border-radius:10px;background:${getSeverityColor(result.severity)}; color:white;">${escapeHtml(result.severity || 'Moderate')}</span>
            </div>
            <div style="font-size: var(--cl-sm); color: var(--cl-text);">
              <p class="mb-2"><strong>Summary:</strong> ${escapeHtml(result.summary)}</p>
              ${redFlagsHtml}
              ${differentialHtml}
              ${adviceHtml}
              <p class="mt-2 text-muted" style="font-size: var(--cl-xs);">This is informational only and not a medical diagnosis.</p>
            </div>
          </div>
        </div>
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();

    // Update severity display
    updateSeverityDisplay(result.severity);
  }

  // Function to update severity display in sidebar
  function updateSeverityDisplay(severity) {
    severityDisplay.innerHTML = `
      <span class="badge" style="padding:6px 10px;border-radius:10px;background:${getSeverityColor(severity)}; color:white;">${escapeHtml(severity || 'Moderate')}</span>
    `;
  }

  // Function to show error message
  function showError(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4';
    messageDiv.innerHTML = `
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>${escapeHtml(message)}
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Handle form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const symptoms = textarea.value.trim();
    if (!symptoms) return;

    // Disable form
    const submitBtn = form.querySelector('button[type=submit]');
    submitBtn.disabled = true;
    textarea.disabled = true;

    // Add user message immediately
    addUserMessage(symptoms);

    // Clear textarea
    textarea.value = '';

    // Add loading indicator
    addLoadingMessage();

    try {
      // Make API request with conversation history
      const response = await fetch('{% url "triage:chat_api" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          'symptoms': symptoms,
          'conversation_history': conversationHistory
        })
      });

      // Remove loading message
      removeLoadingMessage();

      const data = await response.json();

      if (response.ok && data.success) {
        // Add user message to history
        conversationHistory.push({
          role: 'user',
          content: symptoms
        });

        // Add AI response to history
        conversationHistory.push({
          role: 'assistant',
          content: data.result
        });

        // Add AI response to UI
        addAIResponse(data.result);
      } else {
        // Show error
        showError(data.error || 'An error occurred. Please try again.');
      }
    } catch (error) {
      removeLoadingMessage();
      showError('Network error. Please check your connection and try again.');
      console.error('Error:', error);
    } finally {
      // Re-enable form
      submitBtn.disabled = false;
      textarea.disabled = false;
      textarea.focus();
    }
  });

  // Handle Enter key for submission
  textarea.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (textarea.value.trim()) {
        form.dispatchEvent(new Event('submit'));
      }
    }
  });
});
</script>
{% endblock %}
