{% extends 'base.html' %}
{% block content %}
<script>
  // Ensure form works properly
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[action*="appointments/book"]');
    const submitBtn = document.getElementById('submit-appointment-btn');
    
    if (form && submitBtn) {
      // Remove any disabled state
      submitBtn.disabled = false;
      
      // Override base template's form handler
      form.addEventListener('submit', function(e) {
        // Allow form to submit normally - don't disable button
        submitBtn.disabled = false;
        return true;
      }, true); // Use capture phase to run before base template handler
    }
    
    // Ensure all inputs are enabled
    document.querySelectorAll('input, select, textarea').forEach(function(input) {
      input.disabled = false;
      input.readOnly = false;
    });
  });
</script>
<div class="container py-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card">
        <div class="card-header" style="background: var(--cl-blue); color: white;">
          <h3 class="mb-0">
            <i class="fas fa-calendar-plus me-2"></i>Book New Appointment
          </h3>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'appointments:book' %}">
            {% csrf_token %}
            
            <div class="mb-3">
              <label for="{{ form.doctor.id_for_label }}" class="form-label">
                <i class="fas fa-user-doctor me-2"></i>Select Doctor <span class="text-danger">*</span>
              </label>
              {{ form.doctor }}
              {% if form.doctor.errors %}
                <div class="text-danger small mt-1">{{ form.doctor.errors }}</div>
              {% endif %}
              {% if form.doctor.help_text %}
                <small class="form-text text-muted">{{ form.doctor.help_text }}</small>
              {% endif %}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.appointment_date.id_for_label }}" class="form-label">
                  <i class="fas fa-calendar me-2"></i>Appointment Date <span class="text-danger">*</span>
                </label>
                {{ form.appointment_date }}
                {% if form.appointment_date.errors %}
                  <div class="text-danger small mt-1">{{ form.appointment_date.errors }}</div>
                {% endif %}
                {% if form.appointment_date.help_text %}
                  <small class="form-text text-muted">{{ form.appointment_date.help_text }}</small>
                {% endif %}
              </div>

              <div class="col-md-6 mb-3">
                <label for="{{ form.appointment_time.id_for_label }}" class="form-label">
                  <i class="fas fa-clock me-2"></i>Appointment Time <span class="text-danger">*</span>
                </label>
                {{ form.appointment_time }}
                {% if form.appointment_time.errors %}
                  <div class="text-danger small mt-1">{{ form.appointment_time.errors }}</div>
                {% endif %}
                {% if form.appointment_time.help_text %}
                  <small class="form-text text-muted">{{ form.appointment_time.help_text }}</small>
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label for="{{ form.reason.id_for_label }}" class="form-label">
                <i class="fas fa-stethoscope me-2"></i>Reason for Appointment (Optional)
              </label>
              {{ form.reason }}
              {% if form.reason.errors %}
                <div class="text-danger small">{{ form.reason.errors }}</div>
              {% endif %}
              {% if form.reason.help_text %}
                <small class="form-text text-muted">{{ form.reason.help_text }}</small>
              {% endif %}
            </div>

            {% if form.errors %}
              <div class="alert alert-danger">
                <strong>Please correct the following errors:</strong>
                <ul class="mb-0 mt-2">
                  {% for field in form %}
                    {% for error in field.errors %}
                      <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                  {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary" id="submit-appointment-btn">
                <i class="fas fa-check me-2"></i>Book Appointment
              </button>
              <a href="{% url 'appointments:index' %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>Cancel
              </a>
            </div>
          </form>
        </div>
      </div>

      {% if doctors %}
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Available Doctors
          </h5>
        </div>
        <div class="card-body">
          <div class="list-group">
            {% for doctor in doctors %}
            <div class="list-group-item">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                  <i class="fas fa-user-doctor" style="font-size: 2rem; color: var(--cl-blue);"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-0">{{ doctor.get_full_name|default:doctor.username }}</h6>
                  <small class="text-muted">{{ doctor.email }}</small>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
