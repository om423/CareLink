{% extends "base.html" %}
{% load static %}
{% block title %}Triage Details Â· CareLink{% endblock %}
{% block content %}
<div style="background: var(--cl-bg); min-height: calc(100vh - 200px);">
  <!-- Page Header -->
  <header style="background: white; border-bottom: 1px solid var(--cl-border);">
    <div class="container py-3">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          {% if user.is_authenticated and user.patient_profile.role == 'patient' %}
          <a href="{% url 'triage:history' %}" class="btn btn-sm" style="background: transparent; border: none; color: var(--cl-text-muted);">
            <i class="fas fa-arrow-left"></i>
          </a>
          {% elif user.is_authenticated %}
          <a href="{% url 'triage:admin_dashboard' %}" class="btn btn-sm" style="background: transparent; border: none; color: var(--cl-text-muted);">
            <i class="fas fa-arrow-left"></i>
          </a>
          {% endif %}
          <div>
            <h2 class="mb-0" style="font-size: var(--cl-h3); color: var(--cl-text);">Triage Assessment</h2>
            <p class="mb-0" style="font-size: var(--cl-sm); color: var(--cl-text-muted);">
              {{ interaction.created_at|date:"F d, Y" }} at {{ interaction.created_at|date:"g:i A" }}
            </p>
          </div>
        </div>
        {% if user.is_authenticated and user.patient_profile.role == 'patient' %}
        <div class="d-flex gap-2">
          <a href="{% url 'triage:chat' %}" class="btn btn-outline-primary">
            <i class="fas fa-redo me-2"></i>New Assessment
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="container py-4">
    <div class="row g-4">
      <!-- Main Content -->
      <div class="col-lg-8">
        <!-- Severity Card -->
        <div class="card mb-4" style="border: 1px solid var(--cl-border);">
          <div class="card-header bg-transparent border-bottom">
            <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">
              <i class="fas fa-exclamation-triangle me-2" style="color: var(--cl-amber);"></i>
              Severity Assessment
            </h5>
          </div>
          <div class="card-body text-center py-4">
            <span class="badge" style="padding:12px 24px; font-size: var(--cl-h4); border-radius:16px; background:
              {% if interaction.severity == 'Critical' %}var(--cl-red)
              {% elif interaction.severity == 'Severe' %}var(--cl-amber)
              {% elif interaction.severity == 'Moderate' %}var(--cl-teal)
              {% else %}var(--cl-green){% endif %}; color:white;">
              {{ interaction.severity|default:"Moderate" }}
            </span>
          </div>
        </div>

        <!-- Symptoms Card -->
        <div class="card mb-4" style="border: 1px solid var(--cl-border);">
          <div class="card-header bg-transparent border-bottom">
            <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">
              <i class="fas fa-notes-medical me-2" style="color: var(--cl-blue);"></i>
              Your Symptoms
            </h5>
          </div>
          <div class="card-body">
            <p style="font-size: var(--cl-base); color: var(--cl-text); white-space: pre-line; margin-bottom: 0;">{{ interaction.symptoms_text }}</p>
          </div>
        </div>

        <!-- AI Assessment -->
        <div class="card mb-4" style="border: 1px solid var(--cl-border);">
          <div class="card-header bg-transparent border-bottom">
            <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">
              <i class="fas fa-robot me-2" style="color: var(--cl-blue);"></i>
              AI Assessment
            </h5>
          </div>
          <div class="card-body">
            {% if interaction.result %}
              <!-- Summary -->
              {% if interaction.result.summary %}
              <div class="mb-4">
                <h6 style="font-weight: var(--cl-font-medium); color: var(--cl-text); margin-bottom: 0.5rem;">
                  Summary
                </h6>
                <p style="font-size: var(--cl-base); color: var(--cl-text);">{{ interaction.result.summary }}</p>
              </div>
              {% endif %}

              <!-- Red Flags -->
              {% if interaction.result.red_flags %}
              <div class="mb-4">
                <h6 style="font-weight: var(--cl-font-medium); color: var(--cl-text); margin-bottom: 0.5rem;">
                  <i class="fas fa-exclamation-circle me-2" style="color: var(--cl-red);"></i>
                  Red Flags
                </h6>
                <ul class="mb-0" style="padding-left: 1.5rem;">
                  {% for flag in interaction.result.red_flags %}
                  <li style="font-size: var(--cl-base); color: var(--cl-text); margin-bottom: 0.5rem;">{{ flag }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}

              <!-- Differential Diagnosis -->
              {% if interaction.result.differential %}
              <div class="mb-4">
                <h6 style="font-weight: var(--cl-font-medium); color: var(--cl-text); margin-bottom: 0.5rem;">
                  <i class="fas fa-clipboard-list me-2" style="color: var(--cl-teal);"></i>
                  Possible Causes <span style="font-size: var(--cl-sm); font-weight: normal; color: var(--cl-text-muted);">(Not a diagnosis)</span>
                </h6>
                <ul class="mb-0" style="padding-left: 1.5rem;">
                  {% for diagnosis in interaction.result.differential %}
                  <li style="font-size: var(--cl-base); color: var(--cl-text); margin-bottom: 0.5rem;">{{ diagnosis }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}

              <!-- Advice -->
              {% if interaction.result.advice %}
              <div class="alert" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: var(--cl-radius-md);">
                <h6 style="font-weight: var(--cl-font-medium); color: var(--cl-text); margin-bottom: 0.5rem;">
                  <i class="fas fa-lightbulb me-2" style="color: var(--cl-blue);"></i>
                  Advice
                </h6>
                <p style="font-size: var(--cl-base); color: var(--cl-text); margin-bottom: 0;">{{ interaction.result.advice }}</p>
              </div>
              {% endif %}

              <!-- Rationale -->
              {% if interaction.result.rationale %}
              <div class="mb-0">
                <h6 style="font-weight: var(--cl-font-medium); color: var(--cl-text); margin-bottom: 0.5rem;">
                  <i class="fas fa-info-circle me-2" style="color: var(--cl-blue);"></i>
                  Rationale
                </h6>
                <p style="font-size: var(--cl-base); color: var(--cl-text); margin-bottom: 0;">{{ interaction.result.rationale }}</p>
              </div>
              {% endif %}

              <!-- Disclaimer -->
              <div class="alert alert-warning mt-4 mb-0" style="border-radius: var(--cl-radius-md);">
                <small style="font-size: var(--cl-sm);">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Disclaimer:</strong> This is an informational assessment only and not a medical diagnosis. Please consult with a healthcare professional for proper medical advice.
                </small>
              </div>
            {% else %}
              <p class="text-muted mb-0">No assessment data available.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-3" style="border: 1px solid var(--cl-border);">
          <div class="card-header bg-transparent border-bottom">
            <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-column gap-2">
              {% if user.is_authenticated and user.patient_profile.role == 'patient' %}
              <a href="{% url 'triage:chat' %}" class="btn btn-primary w-100 text-start">
                <i class="fas fa-redo me-2"></i>New Assessment
              </a>
              <a href="{% url 'doctors:find_doctor' %}" class="btn btn-outline-primary w-100 text-start">
                <i class="fas fa-map-marker-alt me-2"></i>Find Nearby Care
              </a>
              <a href="{% url 'appointments:index' %}" class="btn btn-outline-success w-100 text-start">
                <i class="fas fa-calendar-check me-2"></i>Book Appointment
              </a>
              {% elif user.is_authenticated %}
              <a href="{% url 'triage:admin_dashboard' %}" class="btn btn-outline-primary w-100 text-start">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
              </a>
              {% endif %}
              <button onclick="window.print()" class="btn btn-outline-secondary w-100 text-start">
                <i class="fas fa-print me-2"></i>Print Report
              </button>
            </div>
          </div>
        </div>

        <!-- Timestamp Info -->
        <div class="card mb-3" style="border: 1px solid var(--cl-border);">
          <div class="card-header bg-transparent border-bottom">
            <h5 class="mb-0" style="font-size: var(--cl-h4); color: var(--cl-text);">Assessment Details</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <small style="color: var(--cl-text-muted); font-size: var(--cl-xs); text-transform: uppercase;">Date</small>
              <div style="font-size: var(--cl-base); color: var(--cl-text); font-weight: var(--cl-font-medium);">
                {{ interaction.created_at|date:"F d, Y" }}
              </div>
            </div>
            <div class="mb-3">
              <small style="color: var(--cl-text-muted); font-size: var(--cl-xs); text-transform: uppercase;">Time</small>
              <div style="font-size: var(--cl-base); color: var(--cl-text); font-weight: var(--cl-font-medium);">
                {{ interaction.created_at|date:"g:i A" }}
              </div>
            </div>
            <div>
              <small style="color: var(--cl-text-muted); font-size: var(--cl-xs); text-transform: uppercase;">Assessment ID</small>
              <div style="font-size: var(--cl-base); color: var(--cl-text); font-weight: var(--cl-font-medium); font-family: monospace;">
                #{{ interaction.id|stringformat:"05d" }}
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Notice -->
        <div class="card" style="border: 2px solid var(--cl-red); background: #fef2f2;">
          <div class="card-body">
            <div class="d-flex gap-3">
              <i class="fas fa-exclamation-triangle fa-lg" style="color: var(--cl-red); flex-shrink: 0; margin-top: 0.125rem;"></i>
              <div>
                <h6 class="mb-2" style="color: var(--cl-red); font-weight: var(--cl-font-medium);">Emergency?</h6>
                <p class="mb-3" style="font-size: var(--cl-xs); color: var(--cl-text-muted);">If you're experiencing a medical emergency, call 911 immediately.</p>
                <button class="btn btn-danger btn-sm w-100">Call 911</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
